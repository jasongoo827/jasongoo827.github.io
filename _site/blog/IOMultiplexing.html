<!DOCTYPE html>

<!--
  portfolYOU Jekyll theme by yousinix
  Free for personal and commercial use under the MIT license
  https://github.com/yousinix/portfolYOU
-->

<html lang="en" class="h-100">

<!-- Google Analytics -->
<!-- Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=G-GNZM4ZG5RT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-GNZM4ZG5RT', {
    'anonymize_ip': true,
    'cookie_flags': 'SameSite=None;Secure'
  });
</script>



<body class="h-100 d-flex flex-column">

  <main class="flex-shrink-0 container mt-5">
    <nav class="navbar navbar-expand-lg navbar-themed">

  <a class="navbar-brand" href="/"><h5><b>jasongoo827</b></h5></a>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
    <i class="fas fa-1x fa-bars text-themed"></i>
  </button>

  <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
    <div class="navbar-nav ml-auto"><a class="nav-item nav-link " href="/CLAUDE">ê¸°ìˆ  ë¸”ë¡œê·¸ í”„ë¡œì íŠ¸</a>

      <a class="nav-item nav-link " href="/projects/">Projects</a>

      <a class="nav-item nav-link active" href="/blog/">Blog</a>

      <a class="nav-item nav-link " href="/about/">About</a>

      

      <span id="theme-toggler" class="nav-item nav-link" role="button" onclick="toggleTheme()"></span>
    </div>
  </div>

</nav>
    <div class="col-lg-10 mx-auto mt-5 markdown-body">
  <div class="row">
  <!-- ë³¸ë¬¸ ì˜ì—­ -->
  <div class="col-md-9">
    <h1><b>I/O Multiplexing in Webserv</b></h1>

    <p class="post-metadata text-muted">
      17 June 2025 -  
      <b>13 mins read time</b>

      <br>Tags: 
        
        <a class="text-decoration-none no-underline" href="/blog/tags#network">
          <span class="tag badge badge-pill text-primary border border-primary">Network</span>
        </a>
        
        <a class="text-decoration-none no-underline" href="/blog/tags#multiplexing">
          <span class="tag badge badge-pill text-primary border border-primary">Multiplexing</span>
        </a>
        
        <a class="text-decoration-none no-underline" href="/blog/tags#kqueue">
          <span class="tag badge badge-pill text-primary border border-primary">kqueue</span>
        </a>
        
        <a class="text-decoration-none no-underline" href="/blog/tags#server">
          <span class="tag badge badge-pill text-primary border border-primary">Server</span>
        </a>
        </p>

    <h2 id="io-ì‘ì—…">I/O ì‘ì—…</h2>
<p>I/O Multiplexingì— ëŒ€í•´ ì„¤ëª…í•˜ê¸°ì— ì•ì„œ, ë¨¼ì € I/O ì‘ì—…ì´ ë¬´ì—‡ì¸ì§€ ì´í•´í•  í•„ìš”ê°€ ìˆë‹¤. I/OëŠ” Input/Ouputì˜ ì•½ìë¡œ, ì…ë ¥ê³¼ ì¶œë ¥ì„ ì˜ë¯¸í•œë‹¤. ì—¬ê¸°ì„œ ì…ë ¥ì´ë€ ì™¸ë¶€ì˜ ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ëŠ” ì‘ì—…ì´ë©°, ì¶œë ¥ì€ í”„ë¡œê·¸ë¨ì´ ì²˜ë¦¬í•œ ë°ì´í„°ë¥¼ ì™¸ë¶€ë¡œ ë‚´ë³´ë‚´ëŠ” ì‘ì—…ì´ë‹¤.
ë„¤íŠ¸ì›Œí¬ í”„ë¡œê·¸ë˜ë°ì—ì„œ I/Oì‘ì—…ì€ ì£¼ë¡œ socketì„ í†µí•œ ë°ì´í„° ì†¡ìˆ˜ì‹ ì„ ì˜ë¯¸í•œë‹¤. Linux/Unix í™˜ê²½ì—ì„œëŠ” socket ë˜í•œ íŒŒì¼ ì¦‰, íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°(File Descriptor, FD)ë¡œ ê´€ë¦¬ë˜ê¸° ë•Œë¬¸ì—, ì¢€ ë” ë„“ì€ ê´€ì ì—ì„œ ë³´ë©´ ì´ëŠ” ê³§ ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ ê°„ì˜ í†µì‹ ì„ í¬í•¨í•œ íŒŒì¼ ì…ì¶œë ¥ ì²˜ë¦¬ ë°©ì‹ ì „ë°˜ì— ëŒ€í•œ ì´ì•¼ê¸°ë¼ê³  í•  ìˆ˜ ìˆë‹¤.</p>

<p>ê²°êµ­ ì›¹ì„œë²„ì™€ ê°™ì€ ë„¤íŠ¸ì›Œí¬ ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ I/O ì‘ì—…ì´ë€, <strong>â€œì–¸ì œ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ì„ ê²ƒì¸ê°€?â€</strong>ë¥¼ ì •ì˜í•˜ëŠ” í•µì‹¬ì ì¸ ë°©ì‹ì´ë¼ í•  ìˆ˜ ìˆë‹¤.</p>

<h2 id="ê¸°ë³¸ê°œë…">ê¸°ë³¸ê°œë…</h2>
<p>ì•ì„œ ì–¸ê¸‰í–ˆë“¯ì´, ë„¤íŠ¸ì›Œí¬ í”„ë¡œê·¸ë¨ì—ì„œ I/O ì‘ì—…ì€ ë°ì´í„°ë¥¼ ì½ê±°ë‚˜ ì“°ëŠ” ê³¼ì •ì´ë‹¤. I/O ì‘ì—…ì€ user spaceì—ì„œ ì§ì ‘ ìˆ˜í–‰í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì—, user processê°€ kernelì— I/O ì‘ì—…ì„ ìš”ì²­í•˜ê³  ì‘ë‹µë°›ëŠ” êµ¬ì¡°ì´ë‹¤.
ì‘ë‹µ ë°›ëŠ” ìˆœì„œ(Synchronous/Asynchronous), ë°›ëŠ” íƒ€ì´ë°(Blocking/Non-Blocking)ì— ë”°ë¼ ì—¬ëŸ¬ ëª¨ë¸ë¡œ ë¶„ë¥˜í•  ìˆ˜ ìˆë‹¤.</p>

<p>â¸»</p>
<h3 id="synchronous">Synchronous</h3>
<ul>
  <li>ëª¨ë“  I/O ì‘ì—…ì´ ì¼ë ¨ì˜ ìˆœì„œë¥¼ ê°€ì§€ê³  ì§„í–‰ëœë‹¤.</li>
  <li>ì‘ì—… ì™„ë£Œë¥¼ user spaceì—ì„œ íŒë‹¨í•´, ë‹¤ìŒ ì‘ì—…ì„ ì–¸ì œ ìš”ì²­í• ì§€ ê²°ì •í•œë‹¤.</li>
</ul>

<h3 id="asynchronous">Asynchronous</h3>
<ul>
  <li>kernelì— I/O ì‘ì—…ì„ ìš”ì²­í•˜ê³  ë‹¤ë¥¸ ì‘ì—…ì„ í•  ìˆ˜ ìˆìœ¼ë‚˜, ìˆœì„œê°€ ë³´ì¥ë˜ì§€ëŠ” ì•ŠëŠ”ë‹¤.</li>
  <li>ì‘ì—… ì™„ë£Œë¥¼ kernel spaceì—ì„œ í†µë³´í•´ ì¤€ë‹¤.</li>
</ul>

<p><img src="https://evan-moon.github.io/static/e075bee6dfcc71a33568cd0ef7b6f61c/dc0d9/thumbnail.webp" alt="Sync&amp;Async" />
<sub>ì´ë¯¸ì§€ ì¶œì²˜: <a href="https://www.geeksforgeeks.org/http-full-form/">https://evan-moon.github.io/2019/09/19/sync-async-blocking-non-blocking/</a></sub></p>

<p>â¸»</p>

<h3 id="blocking">Blocking</h3>
<ul>
  <li>ìš”ì²­í•œ ì‘ì—…ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¸ë‹¤ê°€ ëë‚˜ë©´ ê·¸ ê²°ê³¼ë¥¼ ëŒë ¤ë°›ëŠ”ë‹¤.</li>
</ul>

<h3 id="non-blocking">Non-Blocking</h3>
<ul>
  <li>ì‘ì—… ìš”ì²­ ì´í›„ ê²°ê³¼ëŠ” ë‚˜ì¤‘ì— í•„ìš”í•  ë•Œ ì „ë‹¬ ë°›ëŠ”ë‹¤.</li>
  <li>ì¤‘ê°„ì¤‘ê°„ ìƒíƒœë¥¼ í™•ì¸í•´ ë³¼ ìˆ˜ëŠ” ìˆë‹¤.</li>
</ul>

<p><img src="https://mark-kim.blog/static/9172fd37743404e3409996057cb8b526/17e4a/synchronous_vs_asynchronous.webp" alt="Block-NonBlock" /></p>

<p><sub>ì´ë¯¸ì§€ ì¶œì²˜: <a href="https://www.geeksforgeeks.org/http-full-form/">https://mark-kim.blog/blocking_nonblocking_&amp;_synchronous_asynchronous/</a></sub></p>

<p>â¸»</p>

<p>ì´ 4ê°€ì§€ ê¸°ì¤€ì— ë”°ë¼ I/O ëª¨ë¸ì„ 4ê°€ì§€ë¡œ ë¶„ë¥˜í•  ìˆ˜ ìˆëŠ”ë°, ê° ëª¨ë¸ë“¤ì— ëŒ€í•œ ì„¤ëª…ì„ ì˜ í•´ë†“ì€ ê¸€ì´ ë§ê¸° ë•Œë¬¸ì— ìì„¸í•œ ì„¤ëª…ì„ í•˜ì§€ëŠ” ì•Šê² ë‹¤.</p>

<h2 id="io-multiplexing---asynchronous-blocking">I/O Multiplexing - Asynchronous Blocking</h2>
<p>ì›¹ì„œë²„ì™€ ê°™ì€ ë„¤íŠ¸ì›Œí¬ í”„ë¡œê·¸ë¨ì€ ìˆ˜ì‹­, ìˆ˜ë°± ê°œì˜ í´ë¼ì´ì–¸íŠ¸ì™€ ë™ì‹œì— í†µì‹ í•´ì•¼ í•˜ëŠ” ìƒí™©ì— ìì£¼ ë†“ì¸ë‹¤.
ë‹¨ìˆœí•œ Blocking ë°©ì‹ìœ¼ë¡œëŠ” í•˜ë‚˜ì˜ í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë™ì•ˆ ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ëŠ” ì‘ë‹µì„ ë°›ì„ ìˆ˜ ì—†ë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ I/O Multiplexingì´ë¼ëŠ” ê°œë…ì´ ë“±ì¥í–ˆë‹¤.</p>

<p>I/O Multiplexingì€ í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤ê°€ ì—¬ëŸ¬ ê°œì˜ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°(FD)ë¥¼ ë™ì‹œì— ê°ì‹œí•˜ê³ , ë°ì´í„°ë¥¼ ì½ê±°ë‚˜ ì“¸ ìˆ˜ ìˆëŠ” ìƒíƒœê°€ ë˜ì—ˆì„ ë•Œë§Œ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì´ë‹¤.
ìˆ˜ë§ì€ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° ì¤‘ í˜„ì¬ ì‘ì—… ê°€ëŠ¥í•œ ê²ƒë§Œ ê³¨ë¼ì„œ ì²˜ë¦¬í•˜ê¸° ë•Œë¬¸ì—, CPU ìì›ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì‚¬ìš©í•˜ë©° ë‹¤ìˆ˜ì˜ ì—°ê²°ì„ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤.</p>

<p>ìš´ì˜ì²´ì œë§ˆë‹¤ ì œê³µí•˜ëŠ” Multiplexing ë°©ì‹ì´ ì•½ê°„ì”© ë‹¤ë¥¸ë°, ëª‡ ê°€ì§€ ì¢…ë¥˜ì— ëŒ€í•´ ì„¤ëª…í•˜ê² ë‹¤.</p>

<h3 id="select">select</h3>
<ul>
  <li>ê°€ì¥ ì˜¤ë˜ëœ I/O Multiplexing ë°©ì‹</li>
  <li>ê³ ì •ëœ í¬ê¸°ì˜ FD ë°°ì—´ì„ ì‚¬ìš©(1024ê°œ)</li>
  <li>ëª¨ë“  FDë¥¼ ë§¤ë²ˆ ìˆœíšŒí•˜ì—¬ ì²´í¬</li>
  <li>ëª¨ë“  OSì—ì„œ ì§€ì›</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fd_set</span> <span class="n">readfds</span><span class="p">;</span>
<span class="n">select</span><span class="p">(</span><span class="n">max_fd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readfds</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="poll">poll</h3>
<ul>
  <li>selectì˜ í•œê³„ë¥¼ ê°œì„ í•œ ë°©ì‹ (FD ìˆ˜ ì œí•œ ì—†ìŒ)</li>
  <li>ë°°ì—´ ê¸°ë°˜ì´ì§€ë§Œ ìˆœíšŒ í•„ìš”</li>
  <li>ê° FDë§ˆë‹¤ êµ¬ì¡°ì²´ pollfdë¥¼ ì‚¬ìš©</li>
  <li>ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•˜ì§€ë§Œ, ì–´ë–¤ FDì¸ì§€ ë§¤ë²ˆ ìˆœíšŒí•´ì•¼ í•¨</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">pollfd</span> <span class="n">fds</span><span class="p">[</span><span class="n">NUM</span><span class="p">];</span>
<span class="n">poll</span><span class="p">(</span><span class="n">fds</span><span class="p">,</span> <span class="n">NUM</span><span class="p">,</span> <span class="n">TIMEOUT</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="epoll">epoll</h3>
<ul>
  <li>Linuxì—ì„œ select/pollì˜ ë‹¨ì ì„ ê·¹ë³µí•œ ê³ ì„±ëŠ¥ API</li>
  <li>ì»¤ë„ì´ ì´ë²¤íŠ¸ ëŒ€ê¸° ëª©ë¡ì„ ê´€ë¦¬</li>
  <li>ì´ë²¤íŠ¸ ê¸°ë°˜ -&gt; ë³€ê²½ëœ FDë§Œ ì•Œë ¤ì¤Œ</li>
  <li>epoll_create, epoll_ctl, epoll_waitë¡œ êµ¬ì„±</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">epfd</span> <span class="o">=</span> <span class="n">epoll_create</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
<span class="n">epoll_wait</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">MAX_EVENTS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="iocp">IOCP</h3>
<ul>
  <li>Windowsì—ì„œ ì œê³µí•˜ëŠ” Asynchronous I/O ëª¨ë¸</li>
  <li>ì»¤ë„ì´ I/O ì™„ë£Œë¥¼ ë¹„ë™ê¸°ë¡œ ì•Œë ¤ì£¼ëŠ” ì™„ì „í•œ ë¹„ë™ê¸° ëª¨ë¸</li>
  <li>ìŠ¤ë ˆë“œí’€ê³¼ ì—°ê³„ë˜ì–´ ê³ ì„±ëŠ¥ ë©€í‹° I/O ì²˜ë¦¬ ê°€ëŠ¥</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HANDLE</span> <span class="n">iocp</span> <span class="o">=</span> <span class="n">CreateIoCompletionPort</span><span class="p">(...);</span>
<span class="n">GetQueuedCompletionStatus</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="p">...);</span>
</code></pre></div></div>

<h3 id="kqueue">kqueue</h3>
<ul>
  <li>macOS, FreeBSD, NetBSD ë“±ì—ì„œ ì‚¬ìš©ë˜ëŠ” ê³ ì„±ëŠ¥ ì´ë²¤íŠ¸ í</li>
  <li>epollê³¼ ìœ ì‚¬í•˜ê²Œ ë³€ê²½ëœ ì´ë²¤íŠ¸ë§Œ ê°ì§€</li>
  <li>ì´ë²¤íŠ¸ ë“±ë¡ê³¼ ê°ì§€ë¥¼ ëª¨ë‘ kevent()ë¡œ ì²˜ë¦¬</li>
</ul>

<p>Webserv ê³¼ì œëŠ” macOSì—ì„œ ì§„í–‰í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì—, kqueueë¥¼ ì‚¬ìš©í•´ì„œ I/O Multiplexingì„ êµ¬í˜„í–ˆë‹¤. 
kqueueë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì•Œì•„ì•¼ í•˜ëŠ” ê²ƒì´ ëª‡ ê°€ì§€ ìˆë‹¤.</p>

<ul>
  <li>kqueue(), kevent()</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;sys/event.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">kqueue</span><span class="p">();</span>

<span class="kt">int</span> <span class="nf">kevent</span><span class="p">(</span><span class="kt">int</span> <span class="n">kq</span><span class="p">,</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="nc">kevent</span> <span class="o">*</span> <span class="n">changelist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nchanges</span><span class="p">,</span>
    <span class="k">struct</span> <span class="nc">kevent</span> <span class="o">*</span> <span class="n">eventlist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nevents</span><span class="p">,</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="nc">timespec</span> <span class="o">*</span> <span class="n">timeout</span><span class="p">);</span>
</code></pre></div></div>

<p>kqueue() í•¨ìˆ˜ëŠ” ìƒˆë¡œìš´ ì´ë²¤íŠ¸ íë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ì´ë‹¤. ë°˜í™˜ê°’ì€ ì´ë²¤íŠ¸ íì˜ File Descriptorì´ë‹¤. ì´ëŠ” ì´í›„ì— kevent() í˜¸ì¶œì— ì‚¬ìš©ëœë‹¤.</p>

<p>kevent() í•¨ìˆ˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•˜ê±°ë‚˜, ë°œìƒí•œ ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ì‹œìŠ¤í…œ ì½œì´ë‹¤. ì´ë²¤íŠ¸ ë“±ë¡í•  ë•ŒëŠ” changelistì— ë‹´ì•„ ë„˜ê¸°ë©´ ë˜ê³ , ê°ì§€í•˜ë ¤ë©´ eventlistì— ë°œìƒí•œ ì´ë²¤íŠ¸ë“¤ì„ ë‹´ì•„ ë°˜í™˜ë°›ëŠ”ë‹¤.
timeoutì„ í†µí•´ ëŒ€ê¸° ì‹œê°„ ì¡°ì •ë„ ê°€ëŠ¥í•˜ë‹¤.</p>

<ul>
  <li>kevent êµ¬ì¡°ì²´</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">kevent</span> <span class="p">{</span>
    <span class="kt">uintptr_t</span>  <span class="n">ident</span><span class="p">;</span>    <span class="c1">// ê°ì‹œ ëŒ€ìƒ (íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° ë“±)</span>
    <span class="kt">int16_t</span>    <span class="n">filter</span><span class="p">;</span>   <span class="c1">// ì´ë²¤íŠ¸ ì¢…ë¥˜ (ex: EVFILT_READ, EVFILT_WRITE)</span>
    <span class="kt">uint16_t</span>   <span class="n">flags</span><span class="p">;</span>    <span class="c1">// ë™ì‘ ì„¤ì • í”Œë˜ê·¸ (ex: EV_ADD, EV_ENABLE)</span>
    <span class="kt">uint32_t</span>   <span class="n">fflags</span><span class="p">;</span>   <span class="c1">// filter-specific í”Œë˜ê·¸ (ë§ì´ ì‚¬ìš©ë˜ì§„ ì•ŠìŒ)</span>
    <span class="kt">intptr_t</span>   <span class="n">data</span><span class="p">;</span>     <span class="c1">// ì´ë²¤íŠ¸ì— ë”°ë¼ ì˜ë¯¸ê°€ ë‹¬ë¼ì§ (ex: read ê°€ëŠ¥ ë°”ì´íŠ¸ ìˆ˜)</span>
    <span class="kt">void</span><span class="o">*</span>      <span class="n">udata</span><span class="p">;</span>    <span class="c1">// ìœ ì € ì •ì˜ í¬ì¸í„° (ì»¨í…ìŠ¤íŠ¸ ì „ë‹¬ìš©)</span>
<span class="p">};</span>
</code></pre></div></div>

<p>keventëŠ” ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•˜ê±°ë‚˜, ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì •ë³´ë¥¼ ì „ë‹¬ë°›ì„ ë•Œ ì‚¬ìš©í•˜ëŠ” êµ¬ì¡°ì²´ì´ë‹¤. ident, filter, flagì˜ ê°’ì„ í†µí•´ ì´ë²¤íŠ¸ì— ëŒ€í•œ ì •ë³´ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤.</p>

<p>EV_SET ë§¤í¬ë¡œë¥¼ ì‚¬ìš©í•´ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•  ìˆ˜ ìˆë‹¤.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">struct</span> <span class="nc">kevent</span> <span class="n">change</span><span class="p">;</span>
<span class="n">EV_SET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">change</span><span class="p">,</span> <span class="n">client_fd</span><span class="p">,</span> <span class="n">EVFILT_READ</span><span class="p">,</span> <span class="n">EV_ADD</span> <span class="o">|</span> <span class="n">EV_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">change</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

</code></pre></div></div>

<p>â¸»</p>

<h2 id="êµ¬í˜„">êµ¬í˜„</h2>
<p>kqueueë¥¼ ì‚¬ìš©í•´ ì„œë²„ë¥¼ êµ¬í˜„í•˜ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ ìˆœì„œë¡œ êµ¬í˜„í•´ì•¼ í•œë‹¤.</p>

<ol>
  <li>kqueue ìƒì„±</li>
  <li>Server Socket ìƒì„±</li>
  <li>Server Socketì„ kqueueì— ë“±ë¡</li>
  <li>kqueueì—ì„œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸ ê°ì‹œ</li>
  <li>ì„œë²„ê°€ ëŠì–´ì§€ë©´ ëª¨ë“  ìì› ì •ë¦¬</li>
</ol>

<p>â¸»</p>

<h4 id="kqueue-ìƒì„±">kqueue ìƒì„±</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">bool</span>	<span class="n">ServerManager</span><span class="o">::</span><span class="n">InitKqueue</span><span class="p">(</span><span class="kt">int</span> <span class="o">&amp;</span><span class="n">kq</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">sock_serv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kq</span> <span class="o">=</span> <span class="n">kqueue</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"kqueue fail</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
		<span class="n">close</span><span class="p">(</span><span class="n">sock_serv</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>kqueue í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ ì»¤ë„ë¡œë¶€í„° ì´ë²¤íŠ¸ íë¥¼ ìƒì„±í•œë‹¤.</p>

<p>â¸»</p>

<h4 id="server-socket-ìƒì„±">Server Socket ìƒì„±</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">bool</span>	<span class="n">ServerManager</span><span class="o">::</span><span class="n">InitServerAddress</span><span class="p">(</span><span class="kt">int</span> <span class="o">&amp;</span><span class="n">kq</span><span class="p">,</span> <span class="n">sockaddr_in</span> <span class="o">&amp;</span><span class="n">addr_serv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span>	<span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr_serv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr_serv</span><span class="p">));</span>
	<span class="n">addr_serv</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">addr_serv</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">addr_serv</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">// ...</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p>ì„œë²„ ì†Œì¼“ì„ ë§Œë“¤ê¸° ì „ì— ë¨¼ì € sockaddr_in êµ¬ì¡°ì²´ë¥¼ ì‚¬ìš©í•´ í¬íŠ¸ì™€ IP ì£¼ì†Œë¥¼ ì„¤ì •í•´ì¤€ë‹¤.</p>

<p>AF_INETì€ IPv4ë¥¼ ì˜ë¯¸í•˜ê³ , IPv6ë¥¼ ì“°ë ¤ë©´ AF_INET6ì„ ì‚¬ìš©í•œë‹¤. ì—¬ê¸°ì„œëŠ” IPv4ë¥¼ ì‚¬ìš©í•˜ë‹ˆ AF_INETìœ¼ë¡œ ì„¤ì •í•œë‹¤.</p>

<p>htons(host-to-network short) í˜¸ìŠ¤íŠ¸ ë°”ì´íŠ¸ ìˆœì„œì˜ IP í¬íŠ¸ ë²ˆí˜¸ë¥¼ ë„¤íŠ¸ì›Œí¬ ë°”ì´íŠ¸ ìˆœì„œì˜ IP í¬íŠ¸ ë²ˆí˜¸ë¡œ ë³€í™˜í•œë‹¤.</p>

<p>htonl(host-to-network long) í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í˜¸ìŠ¤íŠ¸ ë°”ì´íŠ¸ ìˆœì„œì˜ IPv4 ì£¼ì†Œë¥¼ ë„¤íŠ¸ì›Œí¬ ë°”ì´íŠ¸ ìˆœì„œì˜ IPv4 ì£¼ì†Œë¡œ ë³€í™˜í•œë‹¤. INADDR_ANYëŠ” 0.0.0.0ì„ ì˜ë¯¸í•˜ë©°, ëª¨ë“  IP ì£¼ì†Œë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ ë°›ê² ë‹¤ëŠ” ëœ»ì´ë‹¤.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">bool</span>	<span class="n">ServerManager</span><span class="o">::</span><span class="n">InitServerSocket</span><span class="p">(</span><span class="kt">int</span> <span class="o">&amp;</span><span class="n">kq</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">sock_serv</span><span class="p">,</span> <span class="n">sockaddr_in</span> <span class="o">&amp;</span><span class="n">addr_serv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sock_serv</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_serv</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">// ì˜ˆì™¸ ì²˜ë¦¬</span>
	<span class="p">}</span>

	<span class="kt">int</span> <span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">sock_serv</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enable</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">// ...</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">sock_serv</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr_serv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr_serv</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">// ...</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">sock_serv</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">// ...</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">utils</span><span class="o">::</span><span class="n">SetNonBlock</span><span class="p">(</span><span class="n">sock_serv</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">// ...</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p>socket() í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ ì„œë²„ ì†Œì¼“ì„ ë§Œë“ ë‹¤. AF_INETì€ IPv4, SOCK_STREAMì€ TCP ì†Œì¼“ í˜•ì‹ì„ ì˜ë¯¸í•œë‹¤. 3ë²ˆì§¸ ë§¤ê°œ ë³€ìˆ˜ëŠ” í”„ë¡œí† ì½œì„ ì˜ë¯¸í•˜ëŠ”ë°, 0ì„ ê°’ìœ¼ë¡œ ë„£ìœ¼ë©´ ìë™ìœ¼ë¡œ ì²« ë²ˆì§¸, ë‘ ë²ˆì§¸ ë§¤ê°œë³€ìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¸ìê°’ì„ ì§€ì •í•´ì¤€ë‹¤.</p>

<p>setsockopt() í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ socket ì˜µì…˜ì„ ì„¤ì •í•´ì¤€ë‹¤. SOL_SOCKETì€ ì˜µì…˜ì„ socket levelë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì´ë‹¤. SO_REUSEADDRì€ ì†Œì¼“ì´ ë‹¤ë¥¸ ì†Œì¼“ì—ì„œ ì‚¬ìš© ì¤‘ì¸ í¬íŠ¸ì— ê°•ì œë¡œ ë°”ì¸ë”©í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” ì˜µì…˜ì¸ë°, ì„œë²„ë¥¼ ìì£¼ ê»ë‹¤ ì¼°ë‹¤ í•˜ëŠ” ê²½ìš°ì— ìœ ìš©í•˜ë‹¤.</p>

<p>bind() í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ ì•ì—ì„œ ë§Œë“  ì†Œì¼“ê³¼ IPì£¼ì†Œ-í¬íŠ¸ ë¥¼ ë¬¶ì–´ì¤€ë‹¤.</p>

<p>ì´ì œ listen() í•¨ìˆ˜ë¥¼ í†µí•´ ë°”ì¸ë”©ì´ ëë‚œ ì„œë²„ ì†Œì¼“ì„ í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ë°›ì„ ìˆ˜ ìˆëŠ” ìƒíƒœë¡œ ë§Œë“ ë‹¤. ë‘ ë²ˆì§¸ ì¸ìì¸ 2048ì€ ë°±ë¡œê·¸ íì˜ í¬ê¸°ë¡œ, ë™ì‹œì— ëŒ€ê¸°í•  ìˆ˜ ìˆëŠ” ì—°ê²° ìš”ì²­ì˜ ìˆ˜ë¥¼ ì˜ë¯¸í•œë‹¤.</p>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ fcntl() í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ ì„œë²„ ì†Œì¼“, ì¦‰ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ë¥¼ O_NONBLOCK ì„¤ì • í•´ì¤€ë‹¤. read ì‹œ blockingìœ¼ë¡œ ì²˜ë¦¬í•˜ë©´ ë°ì´í„°ë¥¼ ì½ì–´ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê¸° ë•Œë¬¸ì— non blockingìœ¼ë¡œ ì„¤ì •í•´ì¤˜ì•¼ í•œë‹¤.</p>

<p>â¸»</p>

<h4 id="server-socketì„-kqueueì—-ë“±ë¡">Server Socketì„ kqueueì— ë“±ë¡</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">bool</span>	<span class="n">ServerManager</span><span class="o">::</span><span class="n">RegistSockserv</span><span class="p">(</span><span class="kt">int</span> <span class="o">&amp;</span><span class="n">kq</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">sock_serv</span><span class="p">,</span> <span class="k">struct</span> <span class="o">::</span><span class="n">kevent</span> <span class="o">&amp;</span><span class="n">change_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">EV_SET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">change_event</span><span class="p">,</span> <span class="n">sock_serv</span><span class="p">,</span> <span class="n">EVFILT_READ</span><span class="p">,</span> <span class="n">EV_ADD</span> <span class="o">|</span> <span class="n">EV_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">::</span><span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">change_event</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">// ...</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p>ì„œë²„ ì†Œì¼“ì„ ìƒì„±í•˜ê³  ë°”ì¸ë”©í•œ í›„ì—, í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ê°ì§€í•˜ê¸° ìœ„í•´ kqueueì— í•´ë‹¹ ì†Œì¼“ì„ ì½ê¸° ì´ë²¤íŠ¸ ëŒ€ìƒìœ¼ë¡œ ë“±ë¡í•´ì•¼ í•œë‹¤.</p>

<p>â¸»</p>

<h4 id="kqueueì—ì„œ-ë°œìƒí•˜ëŠ”-ì´ë²¤íŠ¸-ê°ì‹œ">kqueueì—ì„œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸ ê°ì‹œ</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">bool</span>	<span class="n">ServerManager</span><span class="o">::</span><span class="n">CheckEvent</span><span class="p">(</span><span class="kt">int</span> <span class="o">&amp;</span><span class="n">kq</span><span class="p">,</span> <span class="k">struct</span> <span class="o">::</span><span class="n">kevent</span> <span class="o">*</span><span class="n">events</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">event_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">event_count</span> <span class="o">=</span> <span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_count</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"kevent wait fail</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p>kevent í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ event_count, events ë°°ì—´ì„ ë°›ì•„ì˜¨ë‹¤.</p>

<p>ì•ì—ì„œ ë§Œë“  kqueueì™€ ì„œë²„ ì†Œì¼“ì„ ì‚¬ìš©í•´ events ë°°ì—´ì„ ìˆœíšŒí•´, í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë“¤ì–´ì˜¨ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê³ , ë°œìƒí•œ ì´ë²¤íŠ¸ë“¤ì„ ì²˜ë¦¬í•´ì•¼ í•œë‹¤. ì´ë²¤íŠ¸ ì¢…ë¥˜ë¥¼ í¬ê²Œ 3ê°€ì§€ë¡œ ë¶„ë¥˜í•  ìˆ˜ ìˆë‹¤.</p>

<ul>
  <li>ì„œë²„ ì†Œì¼“ìœ¼ë¡œ ì½ê¸° ì´ë²¤íŠ¸ ë°œìƒ</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">filter</span> <span class="o">==</span> <span class="n">EVFILT_READ</span> <span class="o">&amp;&amp;</span> <span class="n">CheckValidServer</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ident</span><span class="p">))</span>
<span class="p">{</span>
    <span class="kt">int</span> 				<span class="n">sock_client</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span>	<span class="n">addr_client</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">InitClientSocket</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="n">sock_serv</span><span class="p">,</span> <span class="n">change_event</span><span class="p">,</span> <span class="n">sock_client</span><span class="p">,</span> <span class="n">addr_client</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr_client</span><span class="p">))</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
        <span class="k">continue</span> <span class="p">;</span>
    <span class="n">Connection</span> <span class="o">*</span><span class="n">con</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Connection</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="n">sock_client</span><span class="p">,</span> <span class="n">addr_client</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="p">);</span>
    <span class="n">v_connection</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">con</span><span class="p">);</span>
    <span class="n">AddConnectionMap</span><span class="p">(</span><span class="n">sock_client</span><span class="p">,</span> <span class="n">v_connection</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
<span class="p">}</span>

</code></pre></div></div>

<p>ì„œë²„ ì†Œì¼“ìœ¼ë¡œ ì½ê¸° ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆë‹¤ë©´ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìƒˆë¡œìš´ ì—°ê²°ì„ ìš”ì²­í•œ ê²ƒì´ê¸° ë•Œë¬¸ì—, accept() í•¨ìˆ˜ë¥¼ í†µí•´ í´ë¼ì´ì–¸íŠ¸ ì†Œì¼“ì„ ìƒì„±í•˜ê³  ì•ì—ì„œ ì„œë²„ ì†Œì¼“ì˜ ì˜µì…˜ì„ ì„¤ì •í•´ì¤¬ë˜ ê²ƒì²˜ëŸ¼ ë™ì¼í•˜ê²Œ ì§„í–‰ í›„, kqueueì— ë“±ë¡í•´ì¤€ë‹¤. í´ë¼ì´ì–¸íŠ¸ ì†Œì¼“ ìƒì„± ì‹œ Connectionì´ë¼ëŠ” ê°ì²´ë¥¼ ë§Œë“¤ì–´, í´ë¼ì´ì–¸íŠ¸ì˜ ì—°ê²°ê³¼ ê´€ë ¨ëœ ì •ë³´ë¥¼ ê´€ë¦¬í•œë‹¤. ì´ë¥¼ std::mapì— &lt;fd, Connection*&gt;ë¡œ ì €ì¥í•´ request, responseë¥¼ ì²˜ë¦¬í•  ë•Œ ì‚¬ìš©í–ˆë‹¤.</p>

<ul>
  <li>í´ë¼ì´ì–¸íŠ¸ ì†Œì¼“ ì´ë²¤íŠ¸ ë°œìƒ</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// if Client Socket Event</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">connectionmap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ident</span><span class="p">))</span> <span class="o">==</span> <span class="n">connectionmap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="n">Connection</span><span class="o">*</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionmap</span><span class="p">[</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ident</span><span class="p">)];</span>
    <span class="n">connection</span><span class="o">-&gt;</span><span class="n">MainProcess</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">connection</span><span class="o">-&gt;</span><span class="n">UpdateTimeval</span><span class="p">();</span>
    <span class="n">AfterProcess</span><span class="p">(</span><span class="n">connection</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p>í´ë¼ì´ì–¸íŠ¸ ì†Œì¼“ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ, requestì— ëŒ€í•œ ì ì ˆí•œ responseë¥¼ ë§Œë“¤ì–´ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë³´ë‚¸ë‹¤. ì´ì— ê´€í•œ ë¶€ë¶„ì€ ë”°ë¡œ ìì„¸íˆ í¬ìŠ¤íŠ¸ë¡œ ë‹¤ë£° ì˜ˆì •ì´ë‹¤.</p>

<ul>
  <li>ë‚˜ë¨¸ì§€ ê²½ìš°</li>
</ul>

<p>ì´ë¯¸ í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ì²˜ë¦¬í–ˆì§€ë§Œ, ì•Œ ìˆ˜ ì—†ëŠ” ì´ìœ ë¡œ ê³„ì† ìš”ì²­ì´ ë“¤ì–´ì˜¤ëŠ” ê²½ìš°ê°€ ìˆì—ˆë‹¤. ì´ ê²½ìš°ì— EV_EOF í”Œë˜ê·¸ê°€ ì¼œì¡Œì—ˆëŠ”ë°, ì´ ê²½ìš°ì— ì—°ê²°ì„ ì •ìƒì ìœ¼ë¡œ ëŠì„ ìˆ˜ ìˆê²Œ ì²˜ë¦¬í•´ì£¼ì—ˆë‹¤. ë‚˜ì¤‘ì— ì•Œê³ ë³´ë‹ˆ Connectionì„ keep-aliveë¡œ êµ¬í˜„í•˜ì§€ ì•Šì•„ ìƒê¸´ ë¬¸ì œì˜€ëŠ”ë°, keep-aliveë¡œ ìˆ˜ì • í›„ì—ëŠ” EV_EOF í”Œë˜ê·¸ê°€ ì¼œì§€ì§€ ì•Šì•˜ë‹¤. ì½”ë“œëŠ” ë”°ë¡œ ì²¨ë¶€í•˜ì§€ ì•Šê² ë‹¤.</p>

<p>â¸»</p>

<h4 id="ì„œë²„ê°€-ëŠì–´ì§€ë©´-ëª¨ë“ -ìì›-ì •ë¦¬">ì„œë²„ê°€ ëŠì–´ì§€ë©´ ëª¨ë“  ìì› ì •ë¦¬</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>	<span class="n">ServerManager</span><span class="o">::</span><span class="n">CloseAllConnection</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">v_connection</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v_connection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">GetFileFd</span><span class="p">())</span>
		<span class="p">{</span>
			<span class="n">CloseConnectionMap</span><span class="p">(</span><span class="n">v_connection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">GetFileFd</span><span class="p">());</span>
			<span class="n">v_connection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">SetFileFd</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v_connection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">GetPipein</span><span class="p">())</span>
		<span class="p">{</span>
			<span class="n">CloseConnectionMap</span><span class="p">(</span><span class="n">v_connection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">GetPipein</span><span class="p">());</span>
			<span class="n">v_connection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">SetPipein</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v_connection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">GetPipeout</span><span class="p">())</span>
		<span class="p">{</span>
			<span class="n">CloseConnectionMap</span><span class="p">(</span><span class="n">v_connection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">GetPipeout</span><span class="p">());</span>
			<span class="n">v_connection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">SetPipeout</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">CloseVConnection</span><span class="p">(</span><span class="n">v_connection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">GetClientSocketFd</span><span class="p">());</span>
	<span class="p">}</span>
	<span class="n">close</span><span class="p">(</span><span class="n">kq</span><span class="p">);</span>
	<span class="n">v_connection</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
	<span class="n">connectionmap</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ì„œë²„ê°€ ì¢…ë£Œëì„ ë•Œ ë³´ê´€í•˜ê³  ìˆëŠ” Connection, ì—°ê´€ëœ ìì›ë“¤ì„ ëª¨ë‘ ì •ë¦¬í•˜ê³  í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•œë‹¤.</p>

<h2 id="ë§ˆë¬´ë¦¬">ë§ˆë¬´ë¦¬</h2>
<p>ì§€ê¸ˆê¹Œì§€ kqueueë¥¼ í™œìš©í•œ I/O Multiplexing ë°©ì‹ì˜ ì„œë²„ êµ¬í˜„ íë¦„ì„ í•˜ë‚˜ì”© ì‚´í´ë³´ì•˜ë‹¤.
ë‹¨ìˆœíˆ ë™ì‘í•˜ëŠ” ì„œë²„ë¥¼ ë§Œë“œëŠ” ê²ƒì„ ë„˜ì–´, ìš´ì˜ì²´ì œì˜ ì´ë²¤íŠ¸ ê¸°ë°˜ ì‹œìŠ¤í…œ ì½œì´ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€ ì´í•´í•˜ê³ , ì†Œì¼“ì„ ì–´ë–»ê²Œ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ”ì§€ ì²´ê³„ì ìœ¼ë¡œ ì •ë¦¬í•´ë³´ì•˜ë‹¤.</p>

<p>ë‹¤ìŒ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ì´ êµ¬ì¡°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­(Request)ì„ ë¶„ì„í•˜ê³ , ì ì ˆí•œ ì‘ë‹µ(Response)ì„ ìƒì„±í•´ì£¼ëŠ” HTTP ì²˜ë¦¬ ë¡œì§ì— ëŒ€í•´ ì´ì•¼ê¸°í•´ë³´ë ¤ê³  í•œë‹¤. ë˜í•œ ì„¤ì • íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ì–´ë–»ê²Œ ì„œë²„ê°€ ìƒì„±ë˜ëŠ”ì§€ì— ëŒ€í•´ ì„¤ëª…í•  ê²ƒì´ë‹¤.</p>


    
    <div class="pt-5">
      
    </div>
    
  </div>

  <!-- ì‚¬ì´ë“œë°” ì˜ì—­ -->
  <div class="col-md-3">
    <div class="tags-list">
    <h3>ğŸ“‚ íƒœê·¸ ëª©ë¡</h3>
    <ul>
      
      
        
        
        <li>
          <a href="/blog/tags#ai">
            AI (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#automation">
            Automation (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#cmake">
            CMake (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#civilization">
            Civilization (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#claude">
            Claude (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#development">
            Development (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#game-engine">
            Game Engine (9)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#gameanalysis">
            GameAnalysis (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#graphics">
            Graphics (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#http">
            HTTP (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#http">
            Http (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#imgui">
            ImGui (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#makefile">
            Makefile (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#multiplexing">
            Multiplexing (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#network">
            Network (3)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#physics">
            Physics (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#scripting">
            Scripting (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#server">
            Server (2)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#systemdesign">
            SystemDesign (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#tcp-ip">
            TCP/IP (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#unity">
            Unity (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#kqueue">
            kqueue (1)
          </a>
        </li>
      
        
        
        <li>
          <a href="/blog/tags#yaml-cpp">
            yaml-cpp (1)
          </a>
        </li>
      
    </ul>
  </div>
  
  </div>
</div>

</div>
  </main>
  <footer class="mt-auto py-3 text-center">

  <small class="text-muted mb-2">
    <i class="fas fa-code"></i> with <i class="fas fa-heart"></i>
    by <strong>jasongoo827</strong>
  </small>

  <div class="container-fluid justify-content-center"><a class="social mx-1"  href="mailto:jasongoo@naver.com"
       style="color: #6c757d"
       onMouseOver="this.style.color='#db4437'"
       onMouseOut="this.style.color='#6c757d'">
      <i class="fas fa-envelope fa-1x"></i>
    </a><a class="social mx-1"  href="https://www.github.com/jasongoo827"
       style="color: #6c757d"
       onMouseOver="this.style.color='#333333'"
       onMouseOut="this.style.color='#6c757d'">
      <i class="fab fa-github fa-1x"></i>
    </a><a class="social mx-1"  href="https://www.linkedin.com/in/jae-woo-goo-38bba5353"
       style="color: #6c757d"
       onMouseOver="this.style.color='#007bb5'"
       onMouseOut="this.style.color='#6c757d'">
      <i class="fab fa-linkedin-in fa-1x"></i>
    </a><a class="social mx-1"  href="https://www.youtube.com/channel/UC7E6rQHpg4e_c6VHXO0G0XQkoo"
       style="color: #6c757d"
       onMouseOver="this.style.color='#ff0000'"
       onMouseOut="this.style.color='#6c757d'">
      <i class="fab fa-youtube fa-1x"></i>
    </a>

</div><small id="attribution">
    theme <a href="https://github.com/yousinix/portfolYOU">portfolYOU</a>
  </small>

</footer>

  
  <!-- GitHub Buttons -->
<script async defer src="https://buttons.github.io/buttons.js"></script>

<!-- jQuery CDN -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- Popper.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"></script>

<!-- Bootstrap JS CDN -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<!-- wow.js CDN & Activation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.js"></script>
<script> new WOW().init(); </script>

<!-- Initialize all tooltips -->
<script>
$(function () {
    $('[data-toggle="tooltip"]').tooltip()
})
</script>
</body>

</html>